<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SEPHIROTH_V12 // DISSONANCE_PSA</title>
    <style>
        body, html { margin: 0; padding: 0; background: #000; overflow: hidden; font-family: 'Helvetica', 'Arial', sans-serif; cursor: none; }
        
        #viewport { position: relative; width: 100vw; height: 100vh; background: #000; }
        canvas { width: 100%; height: 100%; object-fit: contain; }

        /* VHS OVERLAYS */
        .scanlines {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            background-size: 100% 4px;
        }
        .tracking {
            position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: rgba(255,255,255,0.1);
            z-index: 11; animation: track 5s infinite linear; opacity: 0.5; pointer-events: none;
        }

        /* UI */
        #ui-layer { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; 
            background: #111; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #fff;
        }
        h1 { letter-spacing: 5px; font-weight: bold; text-transform: uppercase; margin-bottom: 10px; color: #f0f0f0; }
        p { font-family: 'Courier New'; color: #888; font-size: 12px; }
        
        button { 
            margin-top: 30px; padding: 20px 60px; border: 2px solid #fff; background: #000; color: #fff; 
            font-weight: bold; letter-spacing: 2px; cursor: pointer; transition: 0.2s; text-transform: uppercase;
        }
        button:hover { background: #fff; color: #000; }
        button:disabled { border-color: #333; color: #333; cursor: wait; }

        #progress { position: absolute; bottom: 0; left: 0; height: 5px; background: #f00; width: 0%; z-index: 200; }

        @keyframes track { 0% { top: -10%; opacity: 0; } 50% { opacity: 0.5; } 100% { top: 110%; opacity: 0; } }
    </style>
</head>
<body>

<div id="ui-layer">
    <h1 id="status">INITIALIZING SYSTEM...</h1>
    <p id="sub-status">[ LOADING ASSETS ]</p>
    <button id="start-btn" disabled>PLEASE WAIT</button>
</div>

<div id="viewport">
    <div class="scanlines"></div>
    <div class="tracking"></div>
    <div id="progress"></div>
    <canvas id="c"></canvas>
</div>

<script>
(function() {
    "use strict";

    const canvas = document.getElementById("c");
    const ctx = canvas.getContext("2d", { alpha: false });
    const uiTitle = document.getElementById("status");
    const uiSub = document.getElementById("sub-status");
    const startBtn = document.getElementById("start-btn");
    const progressBar = document.getElementById("progress");

    canvas.width = 1280;
    canvas.height = 720;

    // --- 1. THE BRAIN (Dual Narrative) ---
    const TRIVIAL_TOPICS = [
        { title: "DENTAL HYGIENE", tips: ["Brush twice daily", "Floss between molars", "Rinse with fluoride", "Smile confidently"] },
        { title: "LAWN MAINTENANCE", tips: ["Aerate the soil", "Fertilize in spring", "Remove weeds", "Water at dawn"] },
        { title: "POSTURE CHECK", tips: ["Straighten your spine", "Relax your shoulders", "Feet flat on floor", "Align the neck"] }
    ];

    const HORROR_THEMES = [
        { name: "THE_ROOTS", msg: "THE SOIL IS FULL OF TEETH", missing: "LAST SEEN: DIGGING", visual: "organic" },
        { name: "THE_SIGNAL", msg: "DO NOT ANSWER THE PHONE", missing: "LAST SEEN: SCREAMING", visual: "static" },
        { name: "THE_HIVE", msg: "SKIN IS A CONTAINER", missing: "LAST SEEN: MOLTING", visual: "flesh" }
    ];

    let state = {
        frame: 0,
        maxFrames: 2100, // 35 seconds
        trivial: null,
        horror: null,
        images: [],
        recorder: null,
        chunks: [],
        audioCtx: null,
        audioDest: null,
        masterGain: null,
        running: false
    };

    // --- 2. ASSET LOADER (Fixing the Image Issue) ---
    async function loadAssets() {
        state.trivial = TRIVIAL_TOPICS[Math.floor(Math.random() * TRIVIAL_TOPICS.length)];
        state.horror = HORROR_THEMES[Math.floor(Math.random() * HORROR_THEMES.length)];
        
        uiTitle.innerText = `PSA: ${state.trivial.title}`;
        
        const seeds = [100, 200, 300, 400].map(n => Math.floor(Math.random() * 1000));
        const urls = [
            `https://picsum.photos/seed/${seeds[0]}/1280/720?grayscale`, // Trivial BG
            `https://picsum.photos/seed/${seeds[1]}/800/800?grayscale&blur=2`, // Missing Person
            `https://picsum.photos/seed/${seeds[2]}/1280/720?grayscale&contrast=2` // Horror Texture
        ];

        let loaded = 0;
        for (let url of urls) {
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.src = url;
            img.onload = () => {
                loaded++;
                state.images.push(img);
                if(loaded === urls.length) enableStart();
            };
        }
    }

    function enableStart() {
        uiTitle.innerText = "BROADCAST READY";
        uiSub.innerText = `[ SCENARIO: ${state.trivial.title} // INTERFERENCE: ${state.horror.name} ]`;
        startBtn.disabled = false;
        startBtn.innerText = "INITIATE PSA";
    }

    // --- 3. AUDIO ENGINE (Corporate to Chaos) ---
    function initAudio() {
        const AC = window.AudioContext || window.webkitAudioContext;
        state.audioCtx = new AC();
        state.audioDest = state.audioCtx.createMediaStreamDestination();
        state.masterGain = state.audioCtx.createGain();
        state.masterGain.gain.value = 0.5;
        state.masterGain.connect(state.audioDest);
        state.masterGain.connect(state.audioCtx.destination); // Monitor

        // 1. Corporate Jingle (Arpeggiator)
        const arp = state.audioCtx.createOscillator();
        const arpGain = state.audioCtx.createGain();
        arp.type = 'sine';
        arp.connect(arpGain).connect(state.masterGain);
        arp.start();
        
        // Music Logic Loop
        let noteIdx = 0;
        const majorScale = [261.63, 329.63, 392.00, 523.25]; // C Major
        const dissonantScale = [240, 245, 255, 100]; // Unsettling
        
        setInterval(() => {
            if(!state.running) { arpGain.gain.value = 0; return; }
            
            // Morph from happy to scary based on timeline
            const progress = state.frame / state.maxFrames;
            const isScary = progress > 0.3 || (state.frame % 400 > 300);
            
            const scale = isScary ? dissonantScale : majorScale;
            const freq = scale[noteIdx % scale.length];
            
            // Detune heavily if scary
            const detune = isScary ? (Math.random()*50 - 25) : 0;
            
            arp.frequency.setValueAtTime(freq + detune, state.audioCtx.currentTime);
            arpGain.gain.setValueAtTime(isScary ? 0.3 : 0.1, state.audioCtx.currentTime);
            arpGain.gain.exponentialRampToValueAtTime(0.001, state.audioCtx.currentTime + 0.5);
            
            noteIdx++;
        }, 250);

        // 2. The Drone (40Hz Fear Freq)
        const drone = state.audioCtx.createOscillator();
        const dGain = state.audioCtx.createGain();
        drone.frequency.value = 40;
        dGain.gain.value = 0.2;
        drone.connect(dGain).connect(state.masterGain);
        drone.start();
    }

    function playJumpscare() {
        const osc = state.audioCtx.createOscillator();
        const g = state.audioCtx.createGain();
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(100, state.audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(3000, state.audioCtx.currentTime + 0.1);
        g.gain.setValueAtTime(0.8, state.audioCtx.currentTime);
        g.gain.linearRampToValueAtTime(0, state.audioCtx.currentTime + 0.3);
        osc.connect(g).connect(state.masterGain);
        osc.start(); osc.stop(state.audioCtx.currentTime + 0.4);
    }

    // --- 4. VISUAL ENGINE (The PSA) ---
    
    // Recursive Tree (The Brand Logo)
    function drawTree(x, y, len, angle, depth, color) {
        if(depth === 0) return;
        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(angle * Math.PI/180);
        ctx.strokeStyle = color;
        ctx.lineWidth = depth;
        ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(0, -len); ctx.stroke();
        drawTree(0, -len, len*0.7, angle - 25, depth-1, color);
        drawTree(0, -len, len*0.7, angle + 25, depth-1, color);
        ctx.restore();
    }

    // Procedural Face (The Missing Person / Fiend)
    function drawFace(x, y, type) {
        ctx.save();
        ctx.translate(x, y);
        
        // Base Head
        ctx.fillStyle = type === 'normal' ? "#ccc" : "#111";
        ctx.beginPath(); ctx.arc(0, 0, 100, 0, Math.PI*2); ctx.fill();
        
        // Features
        ctx.fillStyle = type === 'normal' ? "#000" : "#fff";
        
        if (type === 'normal') {
            // Generic Face
            ctx.fillRect(-40, -20, 20, 10); // L Eye
            ctx.fillRect(20, -20, 20, 10);  // R Eye
            ctx.fillRect(-30, 40, 60, 5);   // Mouth
        } else {
            // The Fiend
            const shake = Math.random()*10;
            ctx.fillRect(-50+shake, -30, 100, 20); // Hollow eyes
            // Vertical Mouth
            ctx.beginPath(); ctx.moveTo(0, 20); ctx.lineTo(0, 80); ctx.strokeStyle="#fff"; ctx.lineWidth=5; ctx.stroke();
            
            // Tree Etched on Face
            drawTree(0, -60, 20, 0, 3, "#f00");
        }
        ctx.restore();
    }

    function render() {
        if (!state.running) return;
        state.frame++;
        
        const progress = state.frame / state.maxFrames;
        progressBar.style.width = `${progress * 100}%`;

        // SCENE CONTROLLER
        const cycle = state.frame % 600; // 10 second loops
        let mode = 'TRIVIAL';
        if (cycle > 300) mode = 'MISSING';
        if (cycle > 550 || Math.random() > 0.98) mode = 'GLITCH';
        if (progress > 0.8) mode = 'ENDGAME';

        // 1. BACKGROUND
        ctx.fillStyle = (mode === 'TRIVIAL') ? "#000080" : "#000"; // Corporate Blue vs Black
        ctx.fillRect(0,0,1280,720);

        if (mode === 'TRIVIAL') {
            // --- CORPORATE SLIDE ---
            if(state.images[0]) {
                ctx.globalAlpha = 0.2;
                ctx.drawImage(state.images[0], 0, 0, 1280, 720);
                ctx.globalAlpha = 1.0;
            }
            
            ctx.fillStyle = "#fff";
            ctx.font = "bold 60px Helvetica";
            ctx.textAlign = "center";
            ctx.fillText(state.trivial.title, 640, 100);
            
            ctx.font = "30px Helvetica";
            ctx.textAlign = "left";
            state.trivial.tips.forEach((tip, i) => {
                ctx.fillText(`â€¢ ${tip}`, 200, 250 + (i*60));
            });
            
            // Logo
            drawTree(1100, 650, 40, 0, 5, "#fff");
            
        } else if (mode === 'MISSING') {
            // --- MISSING PERSON POSTER ---
            ctx.fillStyle = "#f00"; // Alert Red Background
            ctx.fillRect(50, 50, 1180, 620);
            ctx.fillStyle = "#fff";
            ctx.fillRect(60, 60, 1160, 600); // White Paper

            ctx.fillStyle = "#000";
            ctx.font = "bold 100px Helvetica";
            ctx.textAlign = "center";
            ctx.fillText("MISSING", 640, 180);

            // The Photo
            if(state.images[1]) {
                ctx.drawImage(state.images[1], 440, 220, 400, 400);
            } else {
                drawFace(640, 420, 'normal');
            }

            ctx.font = "bold 40px Courier New";
            ctx.fillText(state.horror.missing, 640, 600);

        } else if (mode === 'GLITCH' || mode === 'ENDGAME') {
            // --- THE BREAKDOWN ---
            if(state.frame % 5 === 0) {
                 ctx.fillStyle = Math.random() > 0.5 ? "#fff" : "#000";
                 ctx.fillRect(0,0,1280,720);
            }
            
            // Datamoshing effect (draw previous frame with offset)
            ctx.drawImage(canvas, Math.random()*20-10, Math.random()*20-10);
            
            // The Fiend
            drawFace(640, 360, 'fiend');
            
            ctx.fillStyle = "#fff";
            ctx.font = "100px Courier New";
            ctx.textAlign = "center";
            ctx.fillText(state.horror.msg, 640, 360);
            
            if(mode === 'GLITCH' && Math.random() > 0.8) playJumpscare();
        }

        // 2. GLOBAL CHAOS LAYER
        // RGB Split
        if (Math.random() > 0.95) {
            const split = 10;
            ctx.globalCompositeOperation = 'screen';
            ctx.drawImage(canvas, split, 0);
            ctx.globalCompositeOperation = 'source-over';
        }

        if (state.frame < state.maxFrames) {
            requestAnimationFrame(render);
        } else {
            stop();
        }
    }

    // --- 5. CONTROL ---
    async function start() {
        document.getElementById("ui-layer").style.display = "none";
        initAudio();
        
        const stream = canvas.captureStream(60);
        const combined = new MediaStream([
            ...stream.getVideoTracks(),
            ...state.audioDest.stream.getAudioTracks()
        ]);

        state.recorder = new MediaRecorder(combined, { 
            mimeType: 'video/webm;codecs=vp9,opus',
            videoBitsPerSecond: 5000000 
        });
        
        state.recorder.ondataavailable = e => state.chunks.push(e.data);
        state.recorder.onstop = save;
        state.recorder.start(1000); 
        state.running = true;

        // Voiceover
        const utter = new SpeechSynthesisUtterance("Attention. The following is a public service announcement regarding... " + state.trivial.title);
        utter.lang = 'en-US'; utter.rate = 0.9;
        window.speechSynthesis.speak(utter);

        render();
    }

    function stop() {
        state.running = false;
        state.recorder.stop();
        // Scary ending voice
        const utter = new SpeechSynthesisUtterance("They are in the " + state.horror.visual);
        utter.lang = 'en-US'; utter.pitch = 0.1; utter.rate = 0.5;
        window.speechSynthesis.speak(utter);
    }

    function save() {
        const blob = new Blob(state.chunks, { type: 'video/webm' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `PSA_${state.trivial.title.replace(/\s/g,'_')}.webm`;
        a.click();
        
        uiTitle.innerText = "BROADCAST ENDED";
        uiSub.innerText = "CHECK DOWNLOADS FOLDER";
        document.getElementById("ui-layer").style.display = "flex";
        startBtn.style.display = "none";
    }

    // Boot
    loadAssets();
    startBtn.addEventListener("click", start);

})();
</script>
</body>
</html>
