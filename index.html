<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>D.E.S. // PROJECT_SEPHIROTH_V7</title>
    <style>
        body, html { margin: 0; padding: 0; background: #000; overflow: hidden; font-family: 'Courier New', monospace; color: #fff; }
        #container { position: relative; width: 100vw; height: 100vh; background: #050505; }
        canvas { width: 100%; height: 100%; display: block; image-rendering: pixelated; filter: contrast(1.2) brightness(0.9); }
        
        /* THE OVERLAY */
        #boot-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #000; z-index: 1000; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; text-align: center;
        }
        #progress-bar { width: 300px; height: 4px; background: #222; margin-top: 20px; position: relative; display: none;}
        #progress-fill { width: 0%; height: 100%; background: #f00; transition: width 0.1s; }

        .vhs-lines { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.04), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.04));
            background-size: 100% 4px, 4px 100%;
        }

        button { 
            padding: 15px 40px; background: transparent; color: #f00; border: 1px solid #f00; 
            letter-spacing: 5px; cursor: pointer; font-size: 1rem; transition: 0.3s;
        }
        button:hover { background: #f00; color: #000; box-shadow: 0 0 30px #f00; }
    </style>
</head>
<body>

<div id="boot-screen">
    <h1 style="letter-spacing: 12px; color: #fff;">SIGNAL RECOVERY</h1>
    <p style="color: #444; font-size: 0.7rem; margin-bottom: 30px;">[ DEPARTMENT OF ETHEREAL SAFETY // 1988 ]</p>
    <button id="trigger">DECODE BROADCAST</button>
    <div id="progress-bar"><div id="progress-fill"></div></div>
</div>

<div id="container">
    <canvas id="output"></canvas>
    <div class="vhs-lines"></div>
</div>

<script>
(function() {
    /** * SEPHIROTH V7: THE FINAL BROADCAST
     * Encapsulated to prevent "Redeclaration" errors.
     */
    const canvas = document.getElementById('output');
    const ctx = canvas.getContext('2d');
    const btn = document.getElementById('trigger');
    const bar = document.getElementById('progress-bar');
    const fill = document.getElementById('progress-fill');

    canvas.width = 1280;
    canvas.height = 720;

    let state = {
        frame: 0,
        isRecording: false,
        theme: null,
        img: new Image(),
        chunks: [],
        recorder: null,
        audio: { ctx: null, dest: null }
    };

    const THEMES = [
        { name: "VEIN_EXTRACTION", color: "#300", msg: "UPGRADE THE VESTIGIAL FLESH", voice: "Upgrade the vestigial flesh. The roots require sustenance." },
        { name: "VOID_OBSERVATION", color: "#003", msg: "THE SKY IS A MIRROR", voice: "The sky is a mirror. Do not look into the reflection." },
        { name: "DATA_RECOVERY", color: "#020", msg: "LOG_0x8849: DISAPPEARED", voice: "Missing personnel log 8 8 4 9. Signal lost in the wires." }
    ];

    // --- SOUNDSCAPE GENERATOR ---
    function initSound() {
        const AC = window.AudioContext || window.webkitAudioContext;
        state.audio.ctx = new AC();
        state.audio.dest = state.audio.ctx.createMediaStreamDestination();

        // The "Unease" Drone (Binaural 40Hz/44Hz)
        const osc1 = state.audio.ctx.createOscillator();
        const osc2 = state.audio.ctx.createOscillator();
        const g = state.audio.ctx.createGain();
        osc1.frequency.value = 40;
        osc2.frequency.value = 44;
        g.gain.value = 0.15;
        
        osc1.connect(g); osc2.connect(g);
        g.connect(state.audio.dest);
        g.connect(state.audio.ctx.destination);
        osc1.start(); osc2.start();

        // Melodic FM Synth (Eerie Bells)
        setInterval(() => {
            if(Math.random() > 0.7) playBell(200 + Math.random() * 400);
        }, 3000);
    }

    function playBell(freq) {
        const o = state.audio.ctx.createOscillator();
        const g = state.audio.ctx.createGain();
        o.type = 'triangle';
        o.frequency.setValueAtTime(freq, state.audio.ctx.currentTime);
        g.gain.setValueAtTime(0.1, state.audio.ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.0001, state.audio.ctx.currentTime + 3);
        o.connect(g).connect(state.audio.dest);
        o.connect(g).connect(state.audio.ctx.destination);
        o.start(); o.stop(state.audio.ctx.currentTime + 3);
    }

    function playJumpscare() {
        const o = state.audio.ctx.createOscillator();
        const g = state.audio.ctx.createGain();
        o.type = 'sawtooth';
        o.frequency.setValueAtTime(Math.random() * 100 + 40, state.audio.ctx.currentTime);
        o.frequency.exponentialRampToValueAtTime(800, state.audio.ctx.currentTime + 0.1);
        g.gain.setValueAtTime(0.4, state.audio.ctx.currentTime);
        g.gain.linearRampToValueAtTime(0, state.audio.ctx.currentTime + 0.2);
        o.connect(g).connect(state.audio.dest);
        o.connect(g).connect(state.audio.ctx.destination);
        o.start(); o.stop(state.audio.ctx.currentTime + 0.2);
    }

    // --- VISUAL GENERATORS ---
    function drawTreeOfLife(x, y, len, angle, depth) {
        if (depth === 0) return;
        ctx.beginPath();
        ctx.save();
        ctx.strokeStyle = `rgba(255,0,0,${depth * 0.1})`;
        ctx.lineWidth = depth;
        ctx.translate(x, y);
        ctx.rotate(angle * Math.PI / 180);
        ctx.moveTo(0, 0);
        ctx.lineTo(0, -len);
        ctx.stroke();
        drawTreeOfLife(0, -len, len * 0.8, angle - 25, depth - 1);
        drawTreeOfLife(0, -len, len * 0.8, angle + 25, depth - 1);
        ctx.restore();
    }

    function drawTheFiend() {
        const t = Date.now() * 0.005;
        ctx.save();
        ctx.translate(640 + Math.sin(t)*10, 360);
        
        // Mayan Mask Structure
        ctx.fillStyle = "#111";
        ctx.strokeStyle = "#333";
        ctx.beginPath();
        ctx.moveTo(-180, -220); ctx.lineTo(180, -220); ctx.lineTo(220, 100); ctx.lineTo(0, 320); ctx.lineTo(-220, 100);
        ctx.closePath(); ctx.fill(); ctx.stroke();

        // The Piercing Eyes
        const flicker = Math.random() > 0.96 ? 1 : 0.5;
        ctx.fillStyle = `rgba(255, 255, 255, ${flicker})`;
        ctx.shadowBlur = 40 * flicker; ctx.shadowColor = "#fff";
        ctx.fillRect(-100, -110, 60, 8);
        ctx.fillRect(40, -110, 60, 8);
        
        ctx.restore();
    }

    function render() {
        if(!state.isRecording) return;
        state.frame++;

        // Progress Tracking
        const p = (state.frame / 2100) * 100;
        fill.style.width = `${p}%`;

        // Background
        ctx.fillStyle = "#000";
        ctx.fillRect(0,0, canvas.width, canvas.height);

        if (state.frame % 500 < 350) {
            // --- PSA MODE ---
            ctx.fillStyle = state.theme.color;
            ctx.fillRect(50, 50, 1180, 620);
            
            ctx.fillStyle = "#fff";
            ctx.font = "bold 50px Courier New";
            ctx.fillText("DEPARTMENT OF ETHEREAL SAFETY", 100, 150);
            ctx.font = "30px Courier New";
            ctx.fillText("> " + state.theme.msg, 100, 250);
            
            if(state.img.complete) {
                ctx.globalAlpha = 0.3;
                // Illogical Zoom
                ctx.drawImage(state.img, 200, 200, 100, 100, 800, 300, 300, 300);
                ctx.globalAlpha = 1.0;
            }
            drawTreeOfLife(1100, 650, 40, 0, 8);
        } else {
            // --- ENTITY MODE ---
            if(Math.random() > 0.98) {
                playJumpscare();
                ctx.fillStyle = "#fff"; ctx.fillRect(0,0,1280,720);
            }
            drawTheFiend();
            // Subliminal Overlays
            ctx.fillStyle = "rgba(255,255,255,0.1)";
            ctx.font = "12px monospace";
            ctx.fillText("REDACTED: " + Math.random().toString(36), Math.random()*1280, Math.random()*720);
        }

        // Glitch Logic
        if(Math.random() > 0.95) {
            ctx.drawImage(canvas, Math.random()*10, 0, 1280, 720, 0, 0, 1280, 720);
        }

        if(state.frame >= 2100) stopAll();
        else requestAnimationFrame(render);
    }

    // --- CONTROLS ---
    function stopAll() {
        state.isRecording = false;
        state.recorder.stop();
        document.getElementById('boot-screen').style.display = 'flex';
        document.getElementById('boot-screen').innerHTML = "<h1>SIGNAL CAPTURED</h1><p>The archive has been downloaded.</p>";
    }

    function start() {
        state.theme = THEMES[Math.floor(Math.random() * THEMES.length)];
        state.img.src = `https://picsum.photos/1280/720?grayscale&blur=2&t=${Date.now()}`;
        
        document.getElementById('boot-screen').style.display = 'none';
        bar.style.display = 'block';
        
        initSound();
        
        // Muxing Audio and Video
        const canvasStream = canvas.captureStream(60);
        const combined = new MediaStream([
            ...canvasStream.getVideoTracks(),
            ...state.audio.dest.stream.getAudioTracks()
        ]);

        state.recorder = new MediaRecorder(combined, { mimeType: 'video/webm;codecs=vp9,opus' });
        state.recorder.ondataavailable = e => state.chunks.push(e.data);
        state.recorder.onstop = () => {
            const blob = new Blob(state.chunks, { type: 'video/webm' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `SEPHIROTH_SIGNAL_${Date.now()}.webm`;
            a.click();
        };

        state.recorder.start();
        state.isRecording = true;
        
        // English Text-to-Speech
        const u = new SpeechSynthesisUtterance(state.theme.voice);
        u.lang = 'en-US'; u.pitch = 0.1; u.rate = 0.7;
        window.speechSynthesis.speak(u);
        
        render();
    }

    btn.addEventListener('click', start);
})();
</script>
</body>
</html>
