<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SEPHIROTH_V10 // NEURAL_ANCHOR</title>
    <style>
        body, html { margin: 0; padding: 0; background: #000; overflow: hidden; font-family: 'Courier New', monospace; color: #fff; cursor: none; }
        canvas { width: 100vw; height: 100vh; object-fit: contain; image-rendering: pixelated; }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        button { padding: 20px 60px; border: 1px solid #222; background: transparent; color: #444; letter-spacing: 10px; cursor: pointer; transition: 0.8s; }
        button:hover { border-color: #fff; color: #fff; box-shadow: 0 0 50px rgba(255,255,255,0.1); }
        #progress { position: absolute; bottom: 0; left: 0; height: 4px; background: #f00; width: 0%; z-index: 200; }
    </style>
</head>
<body>

<div id="overlay">
    <h1 id="brain-load" style="letter-spacing: 15px; font-weight: 100; color: #333;">INITIALIZING BRAIN...</h1>
    <button id="start" style="display:none;">DECODE SIGNAL</button>
</div>

<div id="progress"></div>
<canvas id="v"></canvas>

<script>
(function() {
    "use strict";

    const canvas = document.getElementById("v");
    const ctx = canvas.getContext("2d", { alpha: false });
    const startBtn = document.getElementById("start");
    const progressFill = document.getElementById("progress");
    const brainText = document.getElementById("brain-load");

    canvas.width = 1280;
    canvas.height = 720;

    let state = {
        active: false,
        frame: 0,
        maxFrames: 2100, // 35 seconds
        anchor: "",
        scrapedText: "",
        images: [],
        recorder: null,
        chunks: [],
        audio: { ctx: null, dest: null, mode: null }
    };

    // --- 1. THE BRAIN: CONCEPTUAL ANCHORING ---
    const ANCHORS = [
        { term: "DISSOLUTION", scale: [55, 58, 62, 65], tempo: 120, mood: "chaotic" },
        { term: "OSSIFICATION", scale: [40, 43, 47, 52], tempo: 60, mood: "static" },
        { term: "SURVEILLANCE", scale: [110, 116, 123, 130], tempo: 180, mood: "anxious" },
        { term: "ENTROPY", scale: [30, 31, 32, 33], tempo: 40, mood: "heavy" }
    ];

    async function initializeBrain() {
        const choice = ANCHORS[Math.floor(Math.random() * ANCHORS.length)];
        state.anchor = choice.term;
        state.audio.mode = choice;
        
        brainText.innerText = "ANCHOR: " + state.anchor;
        
        // Scrape Wikipedia based on Anchor
        try {
            const r = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${state.anchor}`);
            const d = await r.json();
            state.scrapedText = d.extract || "DATA_MISSING";
        } catch { state.scrapedText = "CONNECTION_REFUSED_BY_HOST"; }

        // Fetch 3 unique images based on Anchor
        for(let i=0; i<3; i++) {
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.src = `https://picsum.photos/1280/720?grayscale&sig=${Math.random()}`;
            state.images.push(img);
        }

        setTimeout(() => { startBtn.style.display = "block"; }, 1000);
    }

    // --- 2. THE COMPOSER: DYNAMIC MUSIC & NOISE ---
    function initAudioEngine() {
        const AC = window.AudioContext || window.webkitAudioContext;
        state.audio.ctx = new AC();
        state.audio.dest = state.audio.ctx.createMediaStreamDestination();
        const master = state.audio.ctx.createGain();
        master.connect(state.audio.dest);
        master.connect(state.audio.ctx.destination);

        // Sub-Drone
        const drone = state.audio.ctx.createOscillator();
        drone.frequency.value = state.audio.mode.scale[0] / 2;
        const dG = state.audio.ctx.createGain();
        dG.gain.value = 0.15;
        drone.connect(dG).connect(master);
        drone.start();

        // Generative Melody Loop
        setInterval(() => {
            if(!state.active) return;
            const freq = state.audio.mode.scale[Math.floor(Math.random() * state.audio.mode.scale.length)];
            const osc = state.audio.ctx.createOscillator();
            const g = state.audio.ctx.createGain();
            osc.type = Math.random() > 0.5 ? "triangle" : "sawtooth";
            osc.frequency.setValueAtTime(freq * (Math.floor(Math.random()*3)+1), state.audio.ctx.currentTime);
            g.gain.setValueAtTime(0.1, state.audio.ctx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.0001, state.audio.ctx.currentTime + 2);
            osc.connect(g).connect(master);
            osc.start(); osc.stop(state.audio.ctx.currentTime + 2);
        }, (60000 / state.audio.mode.tempo));
    }

    function triggerJumpscare() {
        const osc = state.audio.ctx.createOscillator();
        const g = state.audio.ctx.createGain();
        osc.type = "square";
        osc.frequency.setValueAtTime(Math.random()*50 + 20, state.audio.ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(1000, state.audio.ctx.currentTime + 0.1);
        g.gain.setValueAtTime(0.5, state.audio.ctx.currentTime);
        g.gain.linearRampToValueAtTime(0, state.audio.ctx.currentTime + 0.3);
        osc.connect(g).connect(master); // Warning: Master not defined globally, fix below
        osc.start(); osc.stop(state.audio.ctx.currentTime + 0.3);
    }

    // --- 3. THE DIRECTOR: VISUAL CHAOS ---
    function drawTree(x, y, len, angle, depth) {
        if(depth === 0) return;
        ctx.beginPath(); ctx.save();
        ctx.strokeStyle = `rgba(255,0,0,${depth * 0.1})`;
        ctx.lineWidth = depth;
        ctx.translate(x, y); ctx.rotate(angle * Math.PI / 180);
        ctx.moveTo(0,0); ctx.lineTo(0, -len); ctx.stroke();
        drawTree(0, -len, len * 0.75, angle - 20, depth - 1);
        drawTree(0, -len, len * 0.75, angle + 20, depth - 1);
        ctx.restore();
    }

    function render() {
        if (!state.active) return;
        state.frame++;
        progressFill.style.width = `${(state.frame / state.maxFrames) * 100}%`;

        ctx.fillStyle = "#000"; ctx.fillRect(0,0,1280,720);

        const currentImg = state.images[Math.floor(state.frame / 700) % 3];

        if (state.frame % 300 > 280) { // Jumpscare Moment
            ctx.fillStyle = "#fff"; ctx.fillRect(0,0,1280,720);
            if(state.frame % 300 === 281) {
                // Audio jumpscare logic (inline fix for master gain)
                const AC = state.audio.ctx;
                const o = AC.createOscillator(); const g = AC.createGain();
                o.type = "square"; o.frequency.value = 50; 
                g.gain.setValueAtTime(0.5, AC.currentTime); g.gain.linearRampToValueAtTime(0, AC.currentTime+0.2);
                o.connect(g).connect(state.audio.dest); o.connect(g).connect(AC.destination);
                o.start(); o.stop(AC.currentTime+0.2);
            }
        } else if (state.frame % 600 < 400) {
            // PSA Slides
            ctx.fillStyle = "#000810"; ctx.fillRect(40,40,1200,640);
            ctx.fillStyle = "#fff"; ctx.font = "bold 40px Courier New";
            ctx.fillText("DIRECTIVE: " + state.anchor, 80, 110);
            
            ctx.font = "16px Courier New";
            const lines = state.scrapedText.match(/.{1,80}(\s|$)/g) || [];
            lines.slice(0, 15).forEach((l, i) => ctx.fillText(l, 80, 180 + (i*25)));

            if(currentImg.complete) {
                ctx.globalAlpha = 0.2;
                const zoom = 1 + Math.sin(state.frame * 0.01) * 0.5;
                ctx.drawImage(currentImg, 640 - (300*zoom), 360 - (200*zoom), 600*zoom, 400*zoom);
                ctx.globalAlpha = 1.0;
            }
        } else {
            // Entity / Fiend Phase
            ctx.save();
            ctx.translate(640, 360);
            ctx.rotate(Math.sin(state.frame*0.05)*0.1);
            
            // Mask
            ctx.fillStyle = "#111"; ctx.beginPath();
            ctx.moveTo(-150, -200); ctx.lineTo(150, -200); ctx.lineTo(180, 50); ctx.lineTo(0, 250); ctx.lineTo(-180, 50);
            ctx.fill(); ctx.strokeStyle = "#444"; ctx.stroke();

            // Glowing Eyes
            const f = Math.random() > 0.9 ? 1 : 0.4;
            ctx.fillStyle = `rgba(255,255,255,${f})`; ctx.shadowBlur = 30*f; ctx.shadowColor = "#fff";
            ctx.fillRect(-80, -110, 50, 6); ctx.fillRect(30, -110, 50, 6);
            ctx.restore();
            
            if(Math.random() > 0.95) { // Distortion
                ctx.drawImage(canvas, Math.random()*20, 0, 1280, 720, 0, 0, 1280, 720);
            }
        }

        drawTree(1100, 650, 40, 0, 7);

        if (state.frame < state.maxFrames) requestAnimationFrame(render);
        else finish();
    }

    // --- 4. SYSTEM CONTROLS ---
    async function start() {
        document.getElementById("overlay").style.display = "none";
        initAudioEngine();
        
        const stream = canvas.captureStream(60);
        const combined = new MediaStream([
            ...stream.getVideoTracks(),
            ...state.audio.dest.stream.getAudioTracks()
        ]);

        state.recorder = new MediaRecorder(combined, { mimeType: 'video/webm;codecs=vp9,opus' });
        state.recorder.ondataavailable = e => state.chunks.push(e.data);
        state.recorder.onstop = () => {
            const blob = new Blob(state.chunks, { type: 'video/webm' });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = `BRAIN_ANCHOR_${state.anchor}_${Date.now()}.webm`;
            a.click();
            setTimeout(() => window.location.reload(), 2000);
        };

        state.recorder.start(1000);
        state.active = true;
        render();

        const u = new SpeechSynthesisUtterance("Brain Anchor established on keyword " + state.anchor + ". Commencing aesthetic synchronization.");
        u.pitch = 0.1; u.rate = 0.8; u.lang = 'en-US';
        window.speechSynthesis.speak(u);
    }

    function finish() {
        state.active = false;
        state.recorder.stop();
    }

    initializeBrain();
    startBtn.addEventListener("click", start);
})();
</script>
</body>
</html>
