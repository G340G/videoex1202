<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DEPARTMENT_OF_ETHEREAL_SAFETY // RECOVERY_88</title>

<style>
body, html {
  margin: 0;
  padding: 0;
  background: #000;
  overflow: hidden;
  font-family: 'Courier New', monospace;
  color: #fff;
  cursor: none;
}

#canvas-container {
  position: relative;
  width: 100vw;
  height: 100vh;
}

canvas {
  width: 100%;
  height: 100%;
  background: #050505;
  image-rendering: pixelated;
}

#overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 100;
  background: #000;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

#status-bar {
  position: absolute;
  bottom: 20px;
  width: 80%;
  height: 5px;
  background: #222;
  display: none;
}

#progress {
  height: 100%;
  background: #f00;
  width: 0%;
  transition: width 0.1s;
}

button {
  padding: 20px 50px;
  border: 1px solid #555;
  background: transparent;
  color: #fff;
  letter-spacing: 5px;
  cursor: pointer;
}
</style>
</head>
<body>

<div id="overlay">
  <h2 style="letter-spacing: 10px; opacity: 0.7;">PROJECT SEPHIROTH</h2>
  <p style="margin-bottom: 30px; font-size: 0.8rem; color: #555;">
    [ AUTHENTIC_SIGNAL_DECODING_MODE ]
  </p>
  <button id="startBtn">INITIATE BROADCAST</button>
  <div id="status-bar"><div id="progress"></div></div>
</div>

<div id="canvas-container">
  <canvas id="glitchCanvas" width="1280" height="720"></canvas>
</div>

<script>
const canvas = document.getElementById('glitchCanvas');
const ctx = canvas.getContext('2d');
const startBtn = document.getElementById('startBtn');
const progress = document.getElementById('progress');

let audioCtx;
let recorder;
let audioDest;
let chunks = [];
let frame = 0;
let isRecording = false;
let currentTheme = null;
let scrapedImage = new Image();

const PSA_THEMES = [
  {
    title: "ATMOSPHERIC STABILITY",
    instruction: "REMAIN IN LOWER LEVELS",
    voice: "Atmospheric stability is compromised. Remain in lower levels."
  },
  {
    title: "GEOGRAPHICAL DISPLACEMENT",
    instruction: "IGNORE NEW LANDMARKS",
    voice: "Geographical displacement detected. Ignore all new landmarks."
  },
  {
    title: "COGNITIVE MAINTENANCE",
    instruction: "CEASE ALL REFLECTION",
    voice: "Cognitive maintenance required. Cease all internal reflection."
  }
];

/* ===================== AUDIO ===================== */

function setupAudio() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }

  audioDest = audioCtx.createMediaStreamDestination();

  const drone = audioCtx.createOscillator();
  const gain = audioCtx.createGain();

  drone.type = "sine";
  drone.frequency.value = 40;
  gain.gain.value = 0.08;

  drone.connect(gain);
  gain.connect(audioDest);
  gain.connect(audioCtx.destination);

  drone.start();

  return audioDest.stream;
}

function playSting() {
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();

  osc.type = "sawtooth";
  osc.frequency.value = Math.random() * 200 + 80;

  gain.gain.value = 0.3;

  osc.connect(gain);
  gain.connect(audioDest);
  gain.connect(audioCtx.destination);

  osc.start();
  osc.stop(audioCtx.currentTime + 0.3);
}

/* ===================== VISUAL ===================== */

function drawFiend() {
  ctx.save();
  ctx.translate(640, 360);

  ctx.fillStyle = "#111";
  ctx.strokeStyle = "#444";
  ctx.lineWidth = 4;

  ctx.beginPath();
  ctx.moveTo(-180, -250);
  ctx.lineTo(180, -250);
  ctx.lineTo(200, 50);
  ctx.lineTo(0, 300);
  ctx.lineTo(-200, 50);
  ctx.closePath();
  ctx.fill();
  ctx.stroke();

  const flicker = Math.random() > 0.95 ? 1 : 0.5;

  ctx.shadowBlur = 25 * flicker;
  ctx.shadowColor = "white";
  ctx.fillStyle = `rgba(255,255,255,${flicker})`;

  ctx.fillRect(-90, -120, 50, 10);
  ctx.fillRect(40, -120, 50, 10);

  ctx.restore();
}

function render() {
  if (!isRecording) return;

  frame++;
  progress.style.width = ((frame / 2100) * 100) + "%";

  ctx.fillStyle = "#000";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  if (frame % 400 < 250) {

    ctx.fillStyle = "#000033";
    ctx.fillRect(40, 40, 1200, 640);

    ctx.fillStyle = "#fff";
    ctx.font = "bold 40px Courier New";
    ctx.fillText("D.E.S. BROADCAST // " + currentTheme.title, 80, 120);

    ctx.font = "24px Courier New";
    ctx.fillText("STATUS: " + currentTheme.instruction, 80, 170);

    ctx.strokeStyle = "#555";
    ctx.beginPath();
    for (let i = 0; i < 10; i++) {
      ctx.lineTo(100 + i * 100, 500 - Math.random() * 200);
    }
    ctx.stroke();

    if (scrapedImage.complete) {
      ctx.globalAlpha = 0.4;
      ctx.drawImage(scrapedImage, 700, 250, 400, 300);
      ctx.globalAlpha = 1;
    }

  } else {

    if (Math.random() > 0.98) {
      playSting();
      ctx.fillStyle = "#f00";
      ctx.fillRect(0, 0, 1280, 720);
    }

    drawFiend();

    ctx.fillStyle = "#fff";
    ctx.font = "14px monospace";
    ctx.fillText(
      "0x" + Math.random().toString(16).slice(2, 10),
      Math.random() * 1200,
      Math.random() * 700
    );
  }

  if (frame >= 2100) {
    stopBroadcast();
  } else {
    requestAnimationFrame(render);
  }
}

/* ===================== SYSTEM ===================== */

function startBroadcast() {

  chunks = [];
  frame = 0;

  currentTheme = PSA_THEMES[Math.floor(Math.random() * PSA_THEMES.length)];
  scrapedImage.src = "https://picsum.photos/800/600?grayscale&blur=3&random=" + Date.now();

  document.getElementById("overlay").style.display = "none";
  document.getElementById("status-bar").style.display = "block";

  const audioStream = setupAudio();
  const canvasStream = canvas.captureStream(60);

  const combinedStream = new MediaStream([
    ...canvasStream.getVideoTracks(),
    ...audioStream.getAudioTracks()
  ]);

  recorder = new MediaRecorder(combinedStream);

  recorder.ondataavailable = e => {
    if (e.data.size > 0) chunks.push(e.data);
  };

  recorder.onstop = saveVideo;

  recorder.start();

  isRecording = true;
  render();

  window.speechSynthesis.cancel();
  const utter = new SpeechSynthesisUtterance(currentTheme.voice);
  utter.pitch = 0.4;
  utter.rate = 0.75;
  utter.lang = "en-US";
  speechSynthesis.speak(utter);
}

function stopBroadcast() {
  isRecording = false;
  if (recorder && recorder.state !== "inactive") {
    recorder.stop();
  }
}

function saveVideo() {
  const blob = new Blob(chunks, { type: "video/webm" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "SEPHIROTH_DECODED_" + Date.now() + ".webm";
  a.click();

  document.getElementById("overlay").style.display = "flex";
  document.getElementById("overlay").innerHTML =
    "<h1>SIGNAL RECOVERED</h1><p>Check your downloads folder.</p>";
}

startBtn.addEventListener("click", startBroadcast);
</script>

</body>
</html>

