<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DEPARTMENT_OF_ETHEREAL_SAFETY // SEPHIROTH_V9</title>
    <style>
        body, html { margin: 0; padding: 0; background: #000; overflow: hidden; font-family: 'Courier New', monospace; color: #fff; }
        canvas { width: 100vw; height: 100vh; object-fit: contain; image-rendering: pixelated; }
        
        #overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; 
            background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; 
        }
        #ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; }
        #progress { position: absolute; bottom: 0; left: 0; height: 3px; background: #f00; width: 0%; transition: width 0.1s; }

        button { 
            padding: 20px 60px; border: 1px solid #333; background: transparent; color: #555; 
            letter-spacing: 10px; cursor: pointer; transition: 0.4s; font-size: 1.2rem;
        }
        button:hover { border-color: #fff; color: #fff; box-shadow: 0 0 40px rgba(255,255,255,0.2); }
        
        .vhs {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.05), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.05));
            background-size: 100% 3px, 3px 100%; pointer-events: none;
        }
    </style>
</head>
<body>

<div id="overlay">
    <h1 style="letter-spacing: 20px; font-weight: 100; color: #666;">SEPHIROTH_V9</h1>
    <p style="font-size: 0.8rem; color: #333; margin-bottom: 50px;">SIGNAL_RECOVERY_IN_PROGRESS</p>
    <button id="start">DECODE</button>
</div>

<div id="ui"><div class="vhs"></div><div id="progress"></div></div>
<canvas id="c" width="1280" height="720"></canvas>

<script>
(function() {
    "use strict";

    const canvas = document.getElementById("c");
    const ctx = canvas.getContext("2d", { alpha: false });
    const startBtn = document.getElementById("start");
    const progress = document.getElementById("progress");

    let state = {
        active: false,
        frame: 0,
        maxFrames: 1800, // 30 seconds at 60fps
        theme: null,
        scrapedImg: new Image(),
        scrapedText: "",
        recorder: null,
        chunks: [],
        audio: { ctx: null, dest: null, nodes: [] }
    };

    const DIRECTIVES = [
        { id: "ROOT", keywords: "roots,veins,underground,soil", msg: "THE_ROOTS_ARE_HUNGRY", color: "#210" },
        { id: "VOID", keywords: "statue,abandoned,void,eyes", msg: "DO_NOT_OBSERVE_THE_VOID", color: "#002" },
        { id: "FLESH", keywords: "anatomy,meat,medical,teeth", msg: "FLESH_IS_A_TRANSMISSION", color: "#300" }
    ];

    // --- SCRAPER ---
    async function scrape() {
        state.theme = DIRECTIVES[Math.floor(Math.random() * DIRECTIVES.length)];
        const topics = ["Liminality", "Pareidolia", "Cryptid", "Eldritch_horror", "Number_station"];
        const t = topics[Math.floor(Math.random() * topics.length)];
        
        try {
            const r = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${t}`);
            const d = await r.json();
            state.scrapedText = d.extract || "CORRUPT_BUFFER_UNDEFINED";
        } catch { state.scrapedText = "CONNECTION_LOST_TO_CENTRAL_ARCHIVE."; }

        state.scrapedImg.crossOrigin = "anonymous";
        state.scrapedImg.src = `https://images.unsplash.com/photo-1509248961158-e54f6934749c?auto=format&fit=crop&w=1280&q=80&sig=${Math.random()}`;
    }

    // --- AUDIO SYNTH (Complex) ---
    function initAudio() {
        const AC = window.AudioContext || window.webkitAudioContext;
        state.audio.ctx = new AC();
        state.audio.dest = state.audio.ctx.createMediaStreamDestination();

        const master = state.audio.ctx.createGain();
        master.connect(state.audio.dest);
        master.connect(state.audio.ctx.destination);

        // 1. Industrial Heartbeat
        const kick = state.audio.ctx.createOscillator();
        const kickG = state.audio.ctx.createGain();
        kick.frequency.setValueAtTime(50, 0);
        kickG.gain.value = 0.2;
        setInterval(() => {
            kickG.gain.exponentialRampToValueAtTime(0.5, state.audio.ctx.currentTime + 0.01);
            kickG.gain.exponentialRampToValueAtTime(0.001, state.audio.ctx.currentTime + 0.5);
        }, 800);
        kick.connect(kickG).connect(master);
        kick.start();

        // 2. FM Scream
        const mod = state.audio.ctx.createOscillator();
        const car = state.audio.ctx.createOscillator();
        const modG = state.audio.ctx.createGain();
        mod.frequency.value = 150;
        modG.gain.value = 500;
        car.frequency.value = 200;
        mod.connect(modG);
        modG.connect(car.frequency);
        const carG = state.audio.ctx.createGain();
        carG.gain.value = 0.02;
        car.connect(carG).connect(master);
        car.start(); mod.start();

        // 3. Resonant Wind Noise
        const bufferSize = 2 * state.audio.ctx.sampleRate;
        const noiseBuffer = state.audio.ctx.createBuffer(1, bufferSize, state.audio.ctx.sampleRate);
        const output = noiseBuffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) output[i] = Math.random() * 2 - 1;
        const noise = state.audio.ctx.createBufferSource();
        noise.buffer = noiseBuffer;
        noise.loop = true;
        const filter = state.audio.ctx.createBiquadFilter();
        filter.type = "lowpass";
        setInterval(() => {
            filter.frequency.exponentialRampToValueAtTime(Math.random()*2000 + 100, state.audio.ctx.currentTime + 1);
        }, 1000);
        const nG = state.audio.ctx.createGain();
        nG.gain.value = 0.05;
        noise.connect(filter).connect(nG).connect(master);
        noise.start();
    }

    // --- VISUAL ENGINE ---
    function drawTree(x, y, len, angle, branchWidth) {
        ctx.beginPath(); ctx.save();
        ctx.strokeStyle = `rgba(255,0,0,${branchWidth * 0.15})`;
        ctx.lineWidth = branchWidth;
        ctx.translate(x, y); ctx.rotate(angle * Math.PI / 180);
        ctx.moveTo(0, 0); ctx.lineTo(0, -len); ctx.stroke();
        if (len < 8) { ctx.restore(); return; }
        drawTree(0, -len, len * 0.75, angle - (20 + Math.sin(state.frame*0.02)*10), branchWidth * 0.7);
        drawTree(0, -len, len * 0.75, angle + (20 + Math.cos(state.frame*0.02)*10), branchWidth * 0.7);
        ctx.restore();
    }

    function drawFiend() {
        ctx.save(); ctx.translate(640, 360);
        const shake = Math.random() > 0.95 ? (Math.random()-0.5)*20 : 0;
        ctx.translate(shake, shake);

        // Body
        ctx.fillStyle = "#0a0a0a"; ctx.strokeStyle = "#333";
        ctx.beginPath();
        ctx.moveTo(-160, -220); ctx.lineTo(160, -220); ctx.lineTo(200, 80); ctx.lineTo(0, 320); ctx.lineTo(-200, 80);
        ctx.closePath(); ctx.fill(); ctx.stroke();

        // Eyes
        const glow = 0.5 + Math.sin(state.frame*0.1)*0.5;
        ctx.fillStyle = `rgba(255, 255, 255, ${glow})`;
        ctx.shadowBlur = 30 * glow; ctx.shadowColor = "#fff";
        ctx.fillRect(-100, -120, 70, 6); ctx.fillRect(30, -120, 70, 6);
        
        ctx.restore();
    }

    function render() {
        if (!state.active) return;
        state.frame++;
        progress.style.width = `${(state.frame / state.maxFrames) * 100}%`;

        // Clear
        ctx.fillStyle = "#000"; ctx.fillRect(0,0,1280,720);

        if (state.frame % 600 < 450) {
            // PSA PHASE
            ctx.fillStyle = state.theme.color; ctx.fillRect(50, 50, 1180, 620);
            ctx.fillStyle = "#fff"; ctx.font = "bold 40px Courier New";
            ctx.fillText("DEPARTMENT OF ETHEREAL SAFETY", 100, 150);
            ctx.font = "18px Courier New";
            const textLines = state.scrapedText.match(/.{1,90}(\s|$)/g) || [];
            textLines.slice(0, 12).forEach((l, i) => {
                const content = Math.random() > 0.98 ? "██████████████" : l;
                ctx.fillText(content, 100, 230 + (i * 25));
            });

            if (state.scrapedImg.complete) {
                ctx.globalAlpha = 0.15;
                ctx.drawImage(state.scrapedImg, 800, 350, 400, 300);
                ctx.globalAlpha = 1.0;
            }
            drawTree(1150, 650, 45, 0, 6);
        } else {
            // ENTITY PHASE
            if (Math.random() > 0.98) {
                ctx.fillStyle = "#fff"; ctx.fillRect(0,0,1280,720);
            }
            drawFiend();
        }

        // Glitch
        if (Math.random() > 0.96) {
            const h = Math.random() * 50;
            const y = Math.random() * 720;
            ctx.drawImage(canvas, 0, y, 1280, h, Math.random() * 40 - 20, y, 1280, h);
        }

        if (state.frame < state.maxFrames) requestAnimationFrame(render);
        else finish();
    }

    async function start() {
        document.getElementById("overlay").style.display = "none";
        await scrape();
        initAudio();

        const stream = canvas.captureStream(60);
        const combined = new MediaStream([
            ...stream.getVideoTracks(),
            ...state.audio.dest.stream.getAudioTracks()
        ]);

        // Fix freezing: Provide a timeslice and ensure the stream is active
        state.recorder = new MediaRecorder(combined, { mimeType: 'video/webm;codecs=vp9,opus' });
        state.recorder.ondataavailable = e => { if (e.data.size > 0) state.chunks.push(e.data); };
        state.recorder.onstop = save;
        
        state.recorder.start(1000); // 1s slices
        state.active = true;
        render();

        const speak = new SpeechSynthesisUtterance("Warning. Broadcast session " + Math.floor(Math.random()*9000) + " has been initiated. Do not move during the cognitive recalibration phase.");
        speak.lang = 'en-US'; speak.pitch = 0.1; speak.rate = 0.7;
        window.speechSynthesis.speak(speak);
    }

    function finish() {
        state.active = false;
        state.recorder.stop();
    }

    function save() {
        const blob = new Blob(state.chunks, { type: 'video/webm' });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `SEPHIROTH_SIGNAL_${Date.now()}.webm`;
        a.click();
        setTimeout(() => window.location.reload(), 1000);
    }

    startBtn.addEventListener("click", start);
})();
</script>
</body>
</html>
