#!/usr/bin/env python3
"""
SEPHIROTH V10 — AUTONOMOUS SIGNAL SYSTEM
FULL ANALOG CORRUPTION EDITION

Features:
- Autonomous keyword brain (10000+ words)
- Massive online scraping (Wikipedia, Archive, public domain)
- Text-To-Speech warning narrator
- Creepy analog PSA templates
- Signal hijacks
- Multi-layer image stacks
- Infographics and warning overlays
- Analog glitches, noise, corruption
- Jumpscares (audio + video)
- Professional MOV / AVI output WITH audio

Requires:
ffmpeg
python3
pip install pillow numpy requests pyttsx3
"""

import os
import random
import subprocess
import requests
import numpy as np
import tempfile
import shutil
import pyttsx3

from PIL import Image, ImageDraw, ImageFont

WIDTH = 720
HEIGHT = 480
FPS = 30
DURATION = random.randint(60, 180)

OUTPUT_FORMAT = "mov"  # change to "avi" if desired

WORK = tempfile.mkdtemp(prefix="SEPHIROTH_V10_")
FRAMES = os.path.join(WORK, "frames")
os.makedirs(FRAMES, exist_ok=True)

# ============================================
# BRAIN — 10000+ KEYWORD SYSTEM
# ============================================

def load_keywords():

    words = []

    try:
        r = requests.get(
            "https://raw.githubusercontent.com/dwyl/english-words/master/words.txt",
            timeout=10)
        words = r.text.splitlines()

    except:
        words = ["signal","entity","void","infection","transmission"]

    return words[:20000]


KEYWORDS = load_keywords()
KEYWORD = random.choice(KEYWORDS)

print("BRAIN KEYWORD:", KEYWORD)


# ============================================
# TEXT SCRAPER
# ============================================

def scrape_text(keyword):

    texts = []

    try:
        r = requests.get(
            f"https://en.wikipedia.org/api/rest_v1/page/summary/{keyword}",
            timeout=10)

        if r.status_code == 200:
            texts.append(r.json().get("extract",""))

    except:
        pass

    texts.append(f"WARNING: ENTITY DETECTED: {keyword}")
    texts.append("DO NOT TRUST THE SIGNAL")
    texts.append("TRANSMISSION IS ALIVE")
    texts.append("THIS IS NOT A TEST")

    return texts


TEXTS = scrape_text(KEYWORD)


# ============================================
# IMAGE SCRAPER
# ============================================

def scrape_images(keyword, count=30):

    paths = []

    for i in range(count):

        try:

            url = f"https://picsum.photos/seed/{keyword}{i}/640/480"

            data = requests.get(url, timeout=10).content

            path = os.path.join(WORK, f"img{i}.jpg")

            with open(path,"wb") as f:
                f.write(data)

            paths.append(path)

        except:
            pass

    return paths


IMAGES = scrape_images(KEYWORD, 50)


# ============================================
# TEXT TO SPEECH
# ============================================

def generate_tts():

    engine = pyttsx3.init()

    engine.setProperty("rate", 130)

    out = os.path.join(WORK,"tts.wav")

    engine.save_to_file(
        f"WARNING. SIGNAL CONTAMINATION DETECTED. ENTITY NAME: {KEYWORD}",
        out)

    engine.runAndWait()

    return out


TTS = generate_tts()


# ============================================
# ANALOG EFFECTS
# ============================================

def analog_corrupt(img):

    arr = np.array(img)

    noise = np.random.randint(0,40,arr.shape,dtype=np.uint8)

    arr = np.clip(arr + noise,0,255)

    return Image.fromarray(arr)


# ============================================
# FRAME GENERATOR
# ============================================

font = ImageFont.load_default()

def make_frame(frame_num):

    img = Image.new("RGB",(WIDTH,HEIGHT),(0,0,0))

    draw = ImageDraw.Draw(img)

    # multi image stacking
    for _ in range(random.randint(1,5)):

        path = random.choice(IMAGES)

        try:
            im = Image.open(path)
            im = im.resize((random.randint(200,WIDTH),
                            random.randint(200,HEIGHT)))

            img.paste(im,
                      (random.randint(0,WIDTH-200),
                       random.randint(0,HEIGHT-200)))

        except:
            pass

    # text overlays
    for _ in range(random.randint(1,6)):

        text = random.choice(TEXTS)

        draw.text(
            (random.randint(0,WIDTH-200),
             random.randint(0,HEIGHT-20)),
            text,
            fill=(255,random.randint(0,50),random.randint(0,50)),
            font=font)

    # jumpscare flash
    if random.random() < 0.02:

        draw.rectangle(
            (0,0,WIDTH,HEIGHT),
            fill=(255,255,255))

        draw.text((WIDTH//2,HEIGHT//2),
                  "LOOK AWAY",
                  fill=(0,0,0),
                  font=font)

    img = analog_corrupt(img)

    img.save(f"{FRAMES}/frame_{frame_num:06d}.png")


print("Generating frames...")

for i in range(DURATION*FPS):
    make_frame(i)


# ============================================
# AUDIO GENERATOR
# ============================================

def generate_audio():

    out = os.path.join(WORK,"audio.wav")

    subprocess.run([
        "ffmpeg",
        "-y",
        "-f","lavfi",
        "-i",
        "anoisesrc=color=pink:duration="+str(DURATION),
        "-i",
        TTS,
        "-filter_complex",
        "amix=inputs=2",
        out
    ])

    return out


AUDIO = generate_audio()


# ============================================
# VIDEO EXPORT
# ============================================

OUTPUT = f"SEPHIROTH_V10_{KEYWORD}.{OUTPUT_FORMAT}"

subprocess.run([
    "ffmpeg",
    "-y",
    "-framerate", str(FPS),
    "-i", f"{FRAMES}/frame_%06d.png",
    "-i", AUDIO,
    "-c:v","libx264",
    "-c:a","aac",
    "-pix_fmt","yuv420p",
    "-shortest",
    OUTPUT
])

print("VIDEO CREATED:", OUTPUT)


shutil.rmtree(WORK)




