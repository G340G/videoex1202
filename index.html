<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SEPHIROTH_V8 // ENTROPY_NODE_88</title>
    <style>
        body, html { margin: 0; padding: 0; background: #000; overflow: hidden; font-family: 'Courier New', monospace; color: #fff; }
        #canvas-container { position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; }
        canvas { width: 100%; height: 100%; object-fit: contain; image-rendering: pixelated; filter: contrast(1.1) brightness(0.8); }
        
        #overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; 
            background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; 
        }
        #ui-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; }
        
        .scanlines {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            background-size: 100% 3px, 3px 100%; opacity: 0.8;
        }

        button { 
            padding: 15px 40px; border: 1px solid #444; background: transparent; color: #888; 
            letter-spacing: 5px; cursor: pointer; transition: 0.5s; 
        }
        button:hover { border-color: #f00; color: #fff; text-shadow: 0 0 10px #f00; }
        
        #progress-bar { position: absolute; bottom: 0; left: 0; height: 2px; background: #f00; width: 0%; transition: width 0.1s; }
    </style>
</head>
<body>

<div id="overlay">
    <h2 style="letter-spacing: 15px; font-weight: 100; color: #444;">D.E.S. ARCHIVE</h2>
    <p style="font-size: 0.7rem; color: #222; margin-bottom: 40px;">SECURE_HANDSHAKE_REQUIRED</p>
    <button id="startTrigger">INITIATE DECODING</button>
</div>

<div id="canvas-container">
    <canvas id="mainCanvas" width="1280" height="720"></canvas>
    <div id="ui-overlay"><div class="scanlines"></div><div id="progress-bar"></div></div>
</div>

<script>
(function() {
    "use strict";

    const canvas = document.getElementById("mainCanvas");
    const ctx = canvas.getContext("2d", { alpha: false });
    const startBtn = document.getElementById("startTrigger");
    const progress = document.getElementById("progress-bar");

    let state = {
        running: false,
        frame: 0,
        maxFrames: 2100, // ~35 seconds at 60fps
        scrapedText: "INITIALIZING_CONNECTION...",
        scrapedImg: new Image(),
        recorder: null,
        chunks: [],
        audio: { ctx: null, dest: null },
        entityActive: false
    };

    // --- DATA SCRAPING ---
    async function fetchData() {
        const keywords = ["Liminal_space", "Apophenia", "Pareidolia", "MKUltra", "Signal-to-noise_ratio"];
        const k = keywords[Math.floor(Math.random() * keywords.length)];
        try {
            const res = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${k}`);
            const data = await res.json();
            state.scrapedText = data.extract || "CORRUPTION_IN_DATA_STREAM";
        } catch { state.scrapedText = "ARCHIVE_NOT_FOUND. SYSTEM_FAILURE."; }
        
        state.scrapedImg.src = `https://picsum.photos/1280/720?grayscale&blur=2&t=${Date.now()}`;
    }

    // --- AUDIO ENGINE ---
    function initAudio() {
        const AC = window.AudioContext || window.webkitAudioContext;
        state.audio.ctx = new AC();
        state.audio.dest = state.audio.ctx.createMediaStreamDestination();

        // 40Hz Binaural Drone
        const osc1 = state.audio.ctx.createOscillator();
        const osc2 = state.audio.ctx.createOscillator();
        const gain = state.audio.ctx.createGain();
        osc1.frequency.value = 40;
        osc2.frequency.value = 41.5; // Creates a "beat" in the brain
        gain.gain.value = 0.2;

        osc1.connect(gain); osc2.connect(gain);
        gain.connect(state.audio.dest);
        gain.connect(state.audio.ctx.destination);
        osc1.start(); osc2.start();
    }

    function playSting(freq, vol = 0.4) {
        const osc = state.audio.ctx.createOscillator();
        const g = state.audio.ctx.createGain();
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(freq, state.audio.ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(1, state.audio.ctx.currentTime + 0.5);
        g.gain.setValueAtTime(vol, state.audio.ctx.currentTime);
        g.gain.linearRampToValueAtTime(0, state.audio.ctx.currentTime + 0.5);
        osc.connect(g).connect(state.audio.dest);
        osc.connect(g).connect(state.audio.ctx.destination);
        osc.start(); osc.stop(state.audio.ctx.currentTime + 0.6);
    }

    // --- RENDERERS ---
    function drawTree(x, y, len, angle, branchWidth) {
        ctx.beginPath();
        ctx.save();
        ctx.strokeStyle = `rgba(255,0,0,${branchWidth * 0.1})`;
        ctx.lineWidth = branchWidth;
        ctx.translate(x, y);
        ctx.rotate(angle * Math.PI / 180);
        ctx.moveTo(0, 0); ctx.lineTo(0, -len);
        ctx.stroke();
        if (len < 10) { ctx.restore(); return; }
        drawTree(0, -len, len * 0.7, angle - 20, branchWidth * 0.7);
        drawTree(0, -len, len * 0.7, angle + 20, branchWidth * 0.7);
        ctx.restore();
    }

    function drawMayanFiend() {
        ctx.save();
        ctx.translate(640, 360);
        const flicker = Math.random() > 0.9 ? 1 : 0.4;
        
        ctx.fillStyle = "#0a0a0a";
        ctx.beginPath();
        ctx.moveTo(-150, -200); ctx.lineTo(150, -200); ctx.lineTo(180, 50); ctx.lineTo(0, 250); ctx.lineTo(-180, 50);
        ctx.fill(); ctx.strokeStyle = "#222"; ctx.stroke();

        // Shiny glowing eyes
        ctx.fillStyle = `rgba(255,255,255,${flicker})`;
        ctx.shadowBlur = 20 * flicker; ctx.shadowColor = "#fff";
        ctx.fillRect(-80, -100, 50, 8); ctx.fillRect(30, -100, 50, 8);
        ctx.restore();
    }

    function drawPSA() {
        ctx.fillStyle = "#00050a";
        ctx.fillRect(0,0,1280,720);
        
        ctx.strokeStyle = "#333";
        ctx.strokeRect(40,40,1200,640);

        ctx.fillStyle = "#fff";
        ctx.font = "bold 30px Courier New";
        ctx.fillText("DEPARTMENT OF ETHEREAL SAFETY", 80, 100);
        
        ctx.font = "16px Courier New";
        const lines = state.scrapedText.match(/.{1,80}(\s|$)/g) || [];
        lines.slice(0, 10).forEach((line, i) => {
            // Randomly "Redact" words
            const content = Math.random() > 0.95 ? "███████████" : line;
            ctx.fillText(content, 80, 180 + (i * 25));
        });

        if (state.scrapedImg.complete) {
            ctx.globalAlpha = 0.2;
            // Illogical Zoom
            ctx.drawImage(state.scrapedImg, 100, 100, 200, 200, 700, 350, 450, 300);
            ctx.globalAlpha = 1.0;
        }
        
        drawTree(1100, 600, 40, 0, 5);
    }

    // --- MAIN ENGINE ---
    function loop() {
        if (!state.running) return;
        state.frame++;
        
        progress.style.width = `${(state.frame / state.maxFrames) * 100}%`;

        if (state.frame % 450 < 300) {
            state.entityActive = false;
            drawPSA();
        } else {
            if (!state.entityActive) {
                playSting(60);
                state.entityActive = true;
            }
            ctx.fillStyle = "#000"; ctx.fillRect(0,0,1280,720);
            drawMayanFiend();
        }

        // Random Technical Glitch
        if (Math.random() > 0.98) {
            const y = Math.random() * 720;
            ctx.drawImage(canvas, 0, y, 1280, 10, Math.random() * 20 - 10, y, 1280, 10);
        }

        if (state.frame >= state.maxFrames) stop();
        else requestAnimationFrame(loop);
    }

    async function start() {
        document.getElementById("overlay").style.display = "none";
        await fetchData();
        initAudio();

        const canvasStream = canvas.captureStream(60);
        const combined = new MediaStream([
            ...canvasStream.getVideoTracks(),
            ...state.audio.dest.stream.getAudioTracks()
        ]);

        state.recorder = new MediaRecorder(combined, { mimeType: 'video/webm;codecs=vp9,opus' });
        state.recorder.ondataavailable = e => state.chunks.push(e.data);
        state.recorder.onstop = save;
        
        state.recorder.start();
        state.running = true;
        loop();

        // TTS voiceover (English)
        const utter = new SpeechSynthesisUtterance("Warning. Ethereal entropy levels are exceeding safety thresholds. Do not attempt to synchronize with the broadcast.");
        utter.pitch = 0.1; utter.rate = 0.8; utter.lang = 'en-US';
        window.speechSynthesis.speak(utter);
    }

    function stop() {
        state.running = false;
        state.recorder.stop();
    }

    function save() {
        const blob = new Blob(state.chunks, { type: 'video/webm' });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `SEPHIROTH_NODE88_${Date.now()}.webm`;
        a.click();
        window.location.reload(); // Reset for next iteration
    }

    startBtn.addEventListener("click", start);

})();
</script>
</body>
</html>
